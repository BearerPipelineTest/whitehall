<% if session[:design_system] %>
  <%# Copied and pasted layout_for_admin component so that we can customise script and stylesheet paths #%>

  <%
    environment = GovukPublishingComponents::AppHelpers::Environment.current_acceptance_environment
    title_prefix = yield(:browser_title).presence || yield(:title)
    title = (title_prefix.empty? ? "" : "#{title_prefix} - ") + "GOV.UK Whitehall"
  %>
  <!DOCTYPE html>
  <html lang="en" class="govuk-template">
    <head>
      <meta charset="utf-8" />
      <title><%= title %></title>
      <meta name="robots" content="noindex,nofollow,noimageindex">
      <meta name="viewport" content="width=device-width, initial-scale=1">
      <%= csrf_meta_tags %>
      <%= favicon_link_tag "govuk_publishing_components/favicon-#{environment}.png" %>
      <%= stylesheet_link_tag "admin/design-system" %>
      <%= javascript_include_tag "govuk_publishing_components/vendor/modernizr" %>
    </head>
    <body class="gem-c-layout-for-admin govuk-template__body">
      <script>
        document.body.className = ((document.body.className) ? document.body.className + ' js-enabled' : 'js-enabled');
      </script>
      <%= render "govuk_publishing_components/components/skip_link" %>

      <%
        navigation_items = [
          { text: "Switch app", href: Plek.new.external_url_for("signon") },
        ]

        if current_user
          navigation_items += [
            { text: current_user.name, href: Plek.new.external_url_for("signon") },
            { text: "Log out", href: gds_sign_out_path },
          ]
        end
      %>

      <%= render "govuk_publishing_components/components/layout_header", {
        environment: GovukPublishingComponents::AppHelpers::Environment.current_acceptance_environment,
        navigation_items: navigation_items,
      } %>

      <div class="govuk-width-container">
        <%= render "govuk_publishing_components/components/phase_banner", {
          app_name: "New Look",
          phase: "alpha",
          message: "You're trying out the new look for Whitehall. #{link_to("Switch back", admin_toggle_design_system_path, class: "govuk-link govuk-link--no-visited-state")}".html_safe
        } %>

        <div class="container-fluid">
          <ul id="global-nav" class="masthead-tabs list-unstyled">
            <li class="masthead-tab-item js-create-new create-new">
              <a href="#new-document-menu" class="toggler" id="new-document-label">New document</a>
              <%= document_creation_dropdown %>
            </li>
            <%= admin_documents_header_link %>
            <%= admin_statistics_announcements_link %>
            <%= admin_featured_header_link %>
            <%= admin_user_organisation_header_link %>
            <li class="js-more-nav masthead-tab-item">
              <a href="#more-links-menu" id="more-links-label" class="toggler">More</a>
              <ul id="more-links-menu" class="masthead-menu masthead-menu-right js-hidden unstyled" role="menu" aria-labelledby="more-links-label">
                <%= admin_organisations_header_menu_link %>
                <%= admin_policy_groups_header_menu_link %>
                <%= admin_roles_header_menu_link %>
                <%= admin_people_header_menu_link %>
                <%= admin_topical_events_header_menu_link %>
                <%= admin_worldwide_organisations_header_menu_link %>
                <%= admin_world_locations_header_menu_link %>
                <%= admin_fields_of_operation_header_menu_link %>
                <%= admin_cabinet_ministers_header_menu_link %>
                <%= admin_get_involved_header_menu_link %>
                <%= admin_sitewide_settings_header_menu_link %>
                <%= admin_governments_header_menu_link %>
              </ul>
            </li>
          </ul>
        </div>
        <main class="govuk-main-wrapper govuk-main-wrapper--l">
          <% if yield(:title).present? %>
          <div class="govuk-grid-row">
            <div class="govuk-grid-column-two-thirds">
              <span class="govuk-caption-l"><%= yield(:context) %></span>
              <h1 class="govuk-heading-l"><%= yield(:title) %></h1>
            </div>
            <div class="govuk-grid-column-one-third app-grid-column--align-right">
              <%= yield(:title_side) %>
            </div>
          </div>
          <% end %>
          <%= yield %>
        </main>
      </div>

      <%= render "govuk_publishing_components/components/layout_footer", {
        navigation: [
          {
            title: "Support and Feedback",
            items: [
              {
                href: "https://support.publishing.service.gov.uk/technical_fault_report/new",
                text: "Raise a support request",
                attributes: { target: "_blank" }
              },
            ]
          }
        ]
      } %>

      <%= javascript_include_tag "admin/design-system" %>
    </body>
  </html>
<% else %>
  <% environment_style = GovukAdminTemplate.environment_style %>
  <% environment_label = GovukAdminTemplate.environment_label %>
  <% content_for :app_title, 'GOV.UK Whitehall' %>
  <% content_for :page_title, page_title %>
  <% content_for :favicon do %>
    <%= favicon_link_tag environment_style ?
      "admin/favicon-#{environment_style}.png" : "admin/favicon.png" %>
  <% end %>

  <% content_for :head do %>
    <!--[if gt IE 8]><!--><%= stylesheet_link_tag "admin.css", integrity: false %><!--<![endif]-->
    <!--[if IE 7]><%= stylesheet_link_tag "admin-ie7.css" %><script>var ieVersion = 7;</script><![endif]-->
    <!--[if IE 8]><%= stylesheet_link_tag "admin-ie8.css" %><script>var ieVersion = 8;</script><![endif]-->
    <%= csrf_meta_tags %>
  <% end %>

  <% content_for :navbar do %>
    <header class="
      masthead
      navbar
      navbar-default
      navbar-inverse
      navbar-static-top
      <% if environment_style %>environment-indicator<% end %>
      add-bottom-margin" role="banner">
      <div class="navbar-container container-fluid">
        <div class="navbar-header">
          <%# Bootstrap toggle for collapsed navbar content, used at smaller widths %>
          <a class="navbar-toggle" data-toggle="collapse" data-target="header .navbar-collapse">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </a>
          <%= link_to "GOV.UK Whitehall", admin_root_path, :class => 'navbar-brand' %>
          <% if environment_label %>
            <div class="environment-label">
              <%= environment_label %>
            </div>
          <% end %>
        </div>
        <nav role="navigation" class="collapse navbar-collapse">
          <ul class="nav navbar-nav">
            <li><%= link_to "Dashboard", admin_root_path %></li>
            <li><%= link_to "View website", Whitehall.public_root, class: "open_website" %></li>
          </ul>
          <div class="navbar-text pull-right remove-bottom-margin">
            <ul class="list-inline">
                <li>
                    <%= signon_link %>
                </li>
              <% if user_signed_in? %>
                <li>
                  <%= link_to current_user.name, admin_user_path(current_user), id: "#user_settings" %>
                </li>
                <li>
                  <%= link_to "Logout", "/auth/gds/sign_out" %>
                </li>
              <% end %>
              <%= admin_users_header_link  %>
            </ul>
          </div>
        </nav>
        <% if current_user.has_permission?("Preview Design System") %>
          <div class="container-fluid">
            <p>
              <span style="color: #fefefe; display: inline-block; padding: 0 1em;">
                We've got a new look.
              </span>
              <%= link_to "Try it out", admin_toggle_design_system_path, class: "btn btn-primary btn-mini" %>
            </p>
          </div>
        <% end %>
      </div>

      <div class="container-fluid">
        <ul id="global-nav" class="masthead-tabs list-unstyled">
          <li class="masthead-tab-item js-create-new create-new">
            <a href="#new-document-menu" class="toggler" id="new-document-label">New document</a>
            <%= document_creation_dropdown %>
          </li>
          <%= admin_documents_header_link %>
          <%= admin_statistics_announcements_link %>
          <%= admin_featured_header_link %>
          <%= admin_user_organisation_header_link %>
          <li class="js-more-nav masthead-tab-item">
            <a href="#more-links-menu" id="more-links-label" class="toggler">More</a>
            <ul id="more-links-menu" class="masthead-menu masthead-menu-right js-hidden unstyled" role="menu" aria-labelledby="more-links-label">
              <%= admin_organisations_header_menu_link %>
              <%= admin_policy_groups_header_menu_link %>
              <%= admin_roles_header_menu_link %>
              <%= admin_people_header_menu_link %>
              <%= admin_topical_events_header_menu_link %>
              <%= admin_worldwide_organisations_header_menu_link %>
              <%= admin_world_locations_header_menu_link %>
              <%= admin_fields_of_operation_header_menu_link %>
              <%= admin_cabinet_ministers_header_menu_link %>
              <%= admin_get_involved_header_menu_link %>
              <%= admin_sitewide_settings_header_menu_link %>
              <%= admin_governments_header_menu_link %>
            </ul>
          </li>
        </ul>
      </div>
      <section class="notices">
        <%= render partial: "shared/notices" %>
      </section>
    </header>
  <% end %>

  <% content_for :content do %>
    <% if content_for?(:page_class) %>
      <div class="<%= yield(:page_class) %>">
    <% end %>

    <%= yield %>

    <% if content_for?(:page_class) %>
      </div>
    <% end %>
  <% end %>

  <% content_for :body_end do %>
    <%= javascript_include_tag "admin" %>
    <%= render_mustache_templates if Rails.env.development? %>
    <% initialise_script "GOVUK.adminGlobalInitialiser" %>
    <%= javascript_tag(yield :javascript_initialisers) %>
  <% end %>

  <% if user_signed_in? && current_user.has_email? %>
    <% content_for :before_pageview_js do %>
      GOVUKAdmin.setDimension(8, "<%= current_user.organisation_slug.present? ? current_user.organisation_slug : '(not set)' %>")
    <% end %>
  <% end %>

  <%# use the govuk_admin_template layout %>
  <%= render :template => 'layouts/govuk_admin_template' %>
<% end %>
